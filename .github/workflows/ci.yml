name: CityMind CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11" # Compatible con mlflow y pyarrow

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verificar archivo .env.example
        run: |
          if [ ! -f ".env.example" ]; then
            echo "Falta .env.example"; exit 1;
          fi

      - name: Validar estilo del código (no detiene el CI)
        run: |
          flake8 . || echo "Aviso: errores de estilo detectados, pero no detienen el build"

      - name: Crear datos mock para pruebas
        run: |
          python create_mock_data.py

      - name: Simular pipeline con Snakemake (dry-run seguro)
        run: |
          snakemake -n -p --allow-missing-files || echo "Aviso: faltan datos, pero el flujo está bien definido"

      - name: Ejecutar tests con Pytest
        run: |
          pytest -v

      - name: Verificar módulo de insights (sanity check)
        run: |
          python - <<'PYCODE'
          from analytics.data_insights import generate_all_insights
          try:
              insights = generate_all_insights()
              summary = insights.get("summary", {})
              print("::notice::✅ Insights generados correctamente:")
              print(summary)
          except Exception as e:
              print("::error::❌ Error generando insights:", e)
              exit(1)
          PYCODE
